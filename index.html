<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body { font-family: 'Poppins', sans-serif; background-color: #1a1424; color: white; scroll-behavior: smooth; }
  .btn { background-color: #D4AF37; color: black; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; display: inline-block; text-align: center; }
  .btn:hover { transform: scale(1.05); box-shadow: 0 0 20px #D4AF37; }
  .video-slide { max-width: 100%; border-radius: 0.5rem; box-shadow: 0 0 20px #000; }
  .discount-badge { background-color: #ff4d6d; color: white; padding: 0.2rem 0.5rem; font-size: 0.8rem; border-radius: 0.3rem; margin-left: 0.5rem; }
  .faq-question { font-weight: bold; margin-top: 1rem; }
  .footer-links a { color: #D4AF37; text-decoration: underline; }
</style>
</head>
<body><section id="signup" class="py-16 max-w-md mx-auto px-6">
  <h2 class="text-3xl font-bold text-center text-[#D4AF37] mb-8">Sign Up / Login</h2>
  <div class="bg-[#3D2C41] p-8 rounded-xl shadow-lg">
    <input type="email" id="email" placeholder="Email" class="w-full p-3 mb-4 rounded text-black">
    <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-4 rounded text-black">
    <button id="signup-btn" class="btn w-full mb-2">Sign Up</button>
    <button id="login-btn" class="btn w-full mb-2">Login</button>
    <button id="google-login" class="btn w-full mb-2">Sign In with Google</button>
    <p class="mt-2 text-sm text-center text-[#D4AF37]">Forgot password? <a href="#">Reset here</a></p>
    <p class="mt-2 text-sm text-center text-[#ff4d6d]">Support: keishapoa@gmail.com</p>
  </div>
</section>
<!-- Place this at the bottom, just before </body> -->
  <!-- Affiliate Dashboard (Tailwind UI only) -->
<section class="max-w-6xl mx-auto px-6 py-12">
  <h1 class="text-4xl font-bold text-[#D4AF37] mb-10">Affiliate Dashboard</h1>

  <!-- Referral Link -->
  <div class="bg-[#2b1f38] p-6 rounded-xl mb-6 shadow-lg">
    <h2 class="text-2xl font-semibold mb-3">Your Referral Link</h2>
    <div class="flex items-center gap-3">
      <input id="refLink" type="text" readonly class="w-full bg-[#1a1424] border border-[#D4AF37] px-4 py-2 rounded-lg" />
      <button onclick="copyRef()" class="btn">Copy</button>
    </div>
    <p id="copyMsg" class="text-sm text-green-400 mt-2 opacity-0 transition">Copied!</p>
  </div>

  <!-- Top Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-[#2b1f38] p-6 rounded-xl text-center shadow-lg">
      <p class="text-lg font-semibold mb-1">Total Referrals</p>
      <p id="totalReferrals" class="text-3xl font-bold">0</p>
    </div>

    <div class="bg-[#2b1f38] p-6 rounded-xl text-center shadow-lg">
      <p class="text-lg font-semibold mb-1">Total Commissions</p>
      <p id="totalCommissions" class="text-3xl font-bold">$0</p>
    </div>

    <div class="bg-[#2b1f38] p-6 rounded-xl text-center shadow-lg">
      <p class="text-lg font-semibold mb-1">Total Payouts</p>
      <p id="totalPayouts" class="text-3xl font-bold">$0</p>
    </div>

    <div class="bg-[#2b1f38] p-6 rounded-xl text-center shadow-lg">
      <p class="text-lg font-semibold mb-1">High-Tier Sales</p>
      <p id="highTierCount" class="text-3xl font-bold">0</p>
      <p class="text-sm opacity-70">(Diamond + Lifetime)</p>
    </div>
  </div>

  <!-- Commission Breakdown Table -->
  <div class="bg-[#2b1f38] p-6 rounded-xl mb-8 shadow-lg overflow-x-auto">
    <h2 class="text-2xl font-semibold mb-4">Commission Breakdown (50%)</h2>

    <table class="w-full text-left min-w-[720px]">
      <thead>
        <tr class="text-sm text-gray-300">
          <th class="py-2">Plan</th>
          <th class="py-2">Price</th>
          <th class="py-2">Affiliate Commission</th>
          <th class="py-2">Sold (count)</th>
          <th class="py-2">Subtotal</th>
        </tr>
      </thead>
      <tbody class="text-white">
        <tr class="border-t border-[#2f2233]">
          <td class="py-3 font-semibold">Entry</td>
          <td class="py-3">$19</td>
          <td class="py-3">$9.50</td>
          <td class="py-3"><span id="entryCount">0</span></td>
          <td class="py-3"><span id="entrySubtotal">$0</span></td>
        </tr>

        <tr class="border-t border-[#2f2233]">
          <td class="py-3 font-semibold">Pro</td>
          <td class="py-3">$49</td>
          <td class="py-3">$24.50</td>
          <td class="py-3"><span id="proCount">0</span></td>
          <td class="py-3"><span id="proSubtotal">$0</span></td>
        </tr>

        <tr class="border-t border-[#2f2233]">
          <td class="py-3 font-semibold">Diamond</td>
          <td class="py-3">$449</td>
          <td class="py-3">$224.50</td>
          <td class="py-3"><span id="diamondCount">0</span></td>
          <td class="py-3"><span id="diamondSubtotal">$0</span></td>
        </tr>

        <tr class="border-t border-[#2f2233]">
          <td class="py-3 font-semibold">Lifetime</td>
          <td class="py-3">$999</td>
          <td class="py-3">$499.50</td>
          <td class="py-3"><span id="lifetimeCount">0</span></td>
          <td class="py-3"><span id="lifetimeSubtotal">$0</span></td>
        </tr>
      </tbody>
      <tfoot class="text-white border-t border-[#2f2233]">
        <tr>
          <td class="py-3 font-semibold">Totals</td>
          <td></td>
          <td></td>
          <td class="py-3"><span id="totalSold">0</span></td>
          <td class="py-3"><span id="grandTotal">$0</span></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Bonus Progress -->
  <div class="bg-[#2b1f38] p-6 rounded-xl shadow-lg">
    <h2 class="text-2xl font-semibold mb-6">Bonus Milestones (Diamond + Lifetime)</h2>

    <!-- 50 Sales -->
    <div class="mb-6">
      <div class="flex justify-between mb-1">
        <p class="font-semibold">50 Sales → $300 Bonus</p>
        <p id="p50Label" class="text-sm opacity-70">0 / 50</p>
      </div>
      <div class="w-full bg-[#1a1424] rounded-full h-3">
        <div id="p50" class="bg-[#D4AF37] h-3 rounded-full" style="width:0%"></div>
      </div>
    </div>

    <!-- 100 Sales -->
    <div class="mb-6">
      <div class="flex justify-between mb-1">
        <p class="font-semibold">100 Sales → $500 Bonus</p>
        <p id="p100Label" class="text-sm opacity-70">0 / 100</p>
      </div>
      <div class="w-full bg-[#1a1424] rounded-full h-3">
        <div id="p100" class="bg-[#D4AF37] h-3 rounded-full" style="width:0%"></div>
      </div>
    </div>

    <!-- 200 Sales -->
    <div>
      <div class="flex justify-between mb-1">
        <p class="font-semibold">200 Sales → $1,000 Bonus</p>
        <p id="p200Label" class="text-sm opacity-70">0 / 200</p>
      </div>
      <div class="w-full bg-[#1a1424] rounded-full h-3">
        <div id="p200" class="bg-[#D4AF37] h-3 rounded-full" style="width:0%"></div>
      </div>
    </div>
  </div>
</section>
<script>
/* ---------- CONFIG (prices & commission rates) ---------- */
const PRICES = {
  entry: 19,
  pro: 49,
  diamond: 449,
  lifetime: 999
};
const COMMISSION_RATE = 0.5; // 50%

/* ---------- UTILITY ---------- */
function fmt(n) {
  return '$' + Number(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

/* ---------- COPY REF ---------- */
function copyRef() {
  const copyText = document.getElementById("refLink");
  if (!copyText) return;
  navigator.clipboard.writeText(copyText.value || '').then(() => {
    const msg = document.getElementById("copyMsg");
    msg.classList.remove("opacity-0");
    setTimeout(() => msg.classList.add("opacity-0"), 1500);
  });
}

/* ---------- MAIN UPDATE FUNCTION ----------
  Call setAffiliateDataFromFirestore(data) with:
  {
    referralLink: 'https://kairah.studio?ref=CODE',
    entryCount: 12,
    proCount: 5,
    diamondCount: 18,
    lifetimeCount: 2,
    totalReferrals: 37,
    totalPayouts: 0
  }
*/
function setAffiliateDataFromFirestore(data = {}) {
  // counts (make sure numbers)
  const entry = Number(data.entryCount || 0);
  const pro = Number(data.proCount || 0);
  const diamond = Number(data.diamondCount || 0);
  const lifetime = Number(data.lifetimeCount || 0);

  // commission per plan
  const entryComm = PRICES.entry * COMMISSION_RATE;
  const proComm = PRICES.pro * COMMISSION_RATE;
  const diamondComm = PRICES.diamond * COMMISSION_RATE;
  const lifetimeComm = PRICES.lifetime * COMMISSION_RATE;

  // subtotals
  const entrySubtotal = entry * entryComm;
  const proSubtotal = pro * proComm;
  const diamondSubtotal = diamond * diamondComm;
  const lifetimeSubtotal = lifetime * lifetimeComm;

  const grandTotal = entrySubtotal + proSubtotal + diamondSubtotal + lifetimeSubtotal;

  // totals
  const totalSold = entry + pro + diamond + lifetime;
  const highTier = diamond + lifetime;

  // Set referral link
  if (data.referralLink) {
    const refInput = document.getElementById('refLink');
    refInput.value = data.referralLink;
  }

  // DOM updates (counts & subtotals)
  document.getElementById('entryCount').innerText = entry;
  document.getElementById('proCount').innerText = pro;
  document.getElementById('diamondCount').innerText = diamond;
  document.getElementById('lifetimeCount').innerText = lifetime;

  document.getElementById('entrySubtotal').innerText = fmt(entrySubtotal);
  document.getElementById('proSubtotal').innerText = fmt(proSubtotal);
  document.getElementById('diamondSubtotal').innerText = fmt(diamondSubtotal);
  document.getElementById('lifetimeSubtotal').innerText = fmt(lifetimeSubtotal);

  document.getElementById('grandTotal').innerText = fmt(grandTotal);
  document.getElementById('totalSold').innerText = totalSold;
  document.getElementById('highTierCount').innerText = highTier;

  // Top stat cards
  document.getElementById('totalReferrals').innerText = Number(data.totalReferrals || totalSold);
  document.getElementById('totalCommissions').innerText = fmt(grandTotal);
  document.getElementById('totalPayouts').innerText = fmt(Number(data.totalPayouts || 0));

  // Bonus progress (50 / 100 / 200)
  updateProgress('p50', 'p50Label', highTier, 50);
  updateProgress('p100', 'p100Label', highTier, 100);
  updateProgress('p200', 'p200Label', highTier, 200);
}

/* Helper to animate/update progress bars */
function updateProgress(barId, labelId, current, target) {
  const percent = Math.min(100, Math.round((current / target) * 100));
  const w = percent + '%';
  const bar = document.getElementById(barId);
  const label = document.getElementById(labelId);
  if (bar) bar.style.width = w;
  if (label) label.innerText = `${current} / ${target}`;
}

/* Example: manual demo (remove/comment out in production) */
// Demo data — remove this block and call setAffiliateDataFromFirestore(data) from Firebase
// setAffiliateDataFromFirestore({
//   referralLink: 'https://kairah.studio?ref=KAIRAH123',
//   entryCount: 12,
//   proCount: 7,
//   diamondCount: 18,
//   lifetimeCount: 2,
//   totalReferrals: 39,
//   totalPayouts: 0
// });

</script>
  // Import Firebase modules
import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs, addDoc, updateDoc, serverTimestamp } from "firebase/firestore";
import { getAuth, onAuthStateChanged } from "firebase/auth";

// Initialize Firestore
const db = getFirestore(app);

// Initialize Auth
const auth = getAuth(app);
async function createReferralCode(userId) {
  const code = "KAI" + Math.random().toString(36).substring(2, 8).toUpperCase();
  await setDoc(doc(db, "users", userId), {
    referralCode: code,
    referredBy: null, // will set if they used a referral link
    createdAt: serverTimestamp()
  }, { merge: true });

  return code;
}
async function setReferredBy(userId, refCode) {
  // Find affiliate user by referralCode
  const q = query(collection(db, "users"), where("referralCode", "==", refCode));
  const querySnapshot = await getDocs(q);
  if (!querySnapshot.empty) {
    const affiliateDoc = querySnapshot.docs[0];
    await updateDoc(doc(db, "users", userId), {
      referredBy: affiliateDoc.id
    });
    console.log("User referred by:", affiliateDoc.id);
  }
}
async function logSale(buyerId, plan) {
  const userDoc = await getDoc(doc(db, "users", buyerId));
  if (!userDoc.exists()) return;

  const buyerData = userDoc.data();
  const affiliateId = buyerData.referredBy;
  if (!affiliateId) return; // No affiliate

  // Commission calculation
  const prices = { entry: 19, pro: 49, diamond: 449, lifetime: 999 };
  const commission = (prices[plan.toLowerCase()] || 0) * 0.5;

  await addDoc(collection(db, "sales"), {
    buyerID: buyerId,
    affiliateID: affiliateId,
    plan: plan,
    commissionAmount: commission,
    timestamp: serverTimestamp()
  });

  console.log(`Sale logged for ${plan}, commission $${commission}`);
}
async function getAffiliateStats(affiliateId) {
  const salesSnapshot = await getDocs(query(collection(db, "sales"), where("affiliateID", "==", affiliateId)));

  let entry = 0, pro = 0, diamond = 0, lifetime = 0, totalCommission = 0;

  salesSnapshot.forEach(doc => {
    const data = doc.data();
    totalCommission += data.commissionAmount;
    switch(data.plan.toLowerCase()) {
      case "entry": entry++; break;
      case "pro": pro++; break;
      case "diamond": diamond++; break;
      case "lifetime": lifetime++; break;
    }
  });

  return { entry, pro, diamond, lifetime, totalCommission, highTier: diamond + lifetime };
}
