<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body { font-family: 'Poppins', sans-serif; background-color: #1a1424; color: white; scroll-behavior: smooth; }
  .btn { background-color: #D4AF37; color: black; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; display: inline-block; text-align: center; }
  .btn:hover { transform: scale(1.05); box-shadow: 0 0 20px #D4AF37; }
  .video-slide { max-width: 100%; border-radius: 0.5rem; box-shadow: 0 0 20px #000; }
  .discount-badge { background-color: #ff4d6d; color: white; padding: 0.2rem 0.5rem; font-size: 0.8rem; border-radius: 0.3rem; margin-left: 0.5rem; }
  .faq-question { font-weight: bold; margin-top: 1rem; }
  .footer-links a { color: #D4AF37; text-decoration: underline; }
</style>
</head>
<body>
    <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kairah Studio Affiliate Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
body { font-family: 'Poppins', sans-serif; background-color: #1a1424; color: white; scroll-behavior: smooth; }
button { font-weight: 600; transition: all 0.25s; border-radius: 12px; }
button:hover { transform: scale(1.05); box-shadow: 0 0 20px #D4AF37, 0 0 40px #FFD700; }
input:focus { outline: none; box-shadow: 0 0 10px #D4AF37; border-color: #FFD700; }
@keyframes pulse { 0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(1.2) rotate(10deg);opacity:0.8;} }
.animate-pulse { animation: pulse 1s infinite; }
</style>
</head>
<body>

<section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <h1 class="text-3xl sm:text-4xl font-bold text-[#D4AF37] mb-8 sm:mb-10 text-center sm:text-left">Affiliate Dashboard</h1>

  <!-- Referral Link -->
  <div class="bg-[#2b1f38] p-6 rounded-xl mb-6 shadow-lg">
    <h2 class="text-2xl font-semibold mb-3">Your Referral Link</h2>
    <div class="flex flex-col sm:flex-row items-center gap-3">
      <input id="refLink" type="text" readonly class="w-full bg-[#1a1424] border border-[#D4AF37] px-4 py-2 rounded-lg mb-2 sm:mb-0" />
      <button id="copyBtn" onclick="copyRef()" class="bg-gradient-to-r from-[#D4AF37] to-[#FFD700] text-black px-6 py-2 sm:px-8 sm:py-3 rounded-xl font-bold shadow-lg w-full sm:w-auto">Copy Link</button>
      <button onclick="shareLink()" class="bg-[#FF4D6D] text-white px-6 py-2 sm:px-8 sm:py-3 rounded-xl font-bold w-full sm:w-auto">Share Link</button>
    </div>
    <p id="copyMsg" class="text-sm text-green-400 mt-2 opacity-0 transition">Copied!</p>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 mb-8">
    <div class="bg-[#2b1f38] p-6 rounded-xl text-center shadow-lg">
      <p class="text-lg font-semibold mb-1">Total Referrals</p>
      <p id="totalReferrals" class="text-3xl font-bold">0</p>
    </div>
    <div class="bg-[#2b1f38] p-6 rounded-xl text-center shadow-lg">
      <p class="text-lg font-semibold mb-1">Total Commissions</p>
      <p id="totalCommissions" class="text-3xl font-bold">$0</p>
    </div>
    <div class="bg-[#2b1f38] p-6 rounded-xl text-center shadow-lg">
      <p class="text-lg font-semibold mb-1">Total Payouts</p>
      <p id="totalPayouts" class="text-3xl font-bold">$0</p>
    </div>
    <div class="bg-[#2b1f38] p-6 rounded-xl text-center shadow-lg">
      <p class="text-lg font-semibold mb-1">High-Tier Sales</p>
      <p id="highTierCount" class="text-3xl font-bold">0</p>
      <p class="text-sm opacity-70">(Diamond + Lifetime)</p>
    </div>
  </div>

  <!-- Bonus Progress -->
  <div class="bg-[#2b1f38] p-4 sm:p-6 rounded-xl shadow-lg mb-10">
    <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6">Bonus Milestones (Diamond + Lifetime)</h2>

    <div class="mb-4">
      <div class="flex justify-between mb-1">
        <p class="font-semibold">50 Sales â†’ $300 Bonus</p>
        <p id="p50Label" class="text-sm opacity-70">0 / 50</p>
      </div>
      <div class="w-full bg-[#1a1424] rounded-full h-3 sm:h-4">
        <div id="p50" class="bg-[#D4AF37] h-3 sm:h-4 rounded-full" style="width:0%"></div>
      </div>
    </div>

    <div class="mb-4">
      <div class="flex justify-between mb-1">
        <p class="font-semibold">100 Sales â†’ $500 Bonus</p>
        <p id="p100Label" class="text-sm opacity-70">0 / 100</p>
      </div>
      <div class="w-full bg-[#1a1424] rounded-full h-3 sm:h-4">
        <div id="p100" class="bg-[#D4AF37] h-3 sm:h-4 rounded-full" style="width:0%"></div>
      </div>
    </div>

    <div>
      <div class="flex justify-between mb-1">
        <p class="font-semibold">200 Sales â†’ $1,000 Bonus</p>
        <p id="p200Label" class="text-sm opacity-70">0 / 200</p>
      </div>
      <div class="w-full bg-[#1a1424] rounded-full h-3 sm:h-4">
        <div id="p200" class="bg-[#D4AF37] h-3 sm:h-4 rounded-full" style="width:0%"></div>
      </div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="bg-[#2b1f38] p-4 sm:p-6 rounded-xl shadow-lg mb-6">
    <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6">Top Affiliates</h2>
    <div id="leaderboard" class="space-y-2 sm:space-y-4">
      <p class="text-sm opacity-50">Loading leaderboard...</p>
    </div>
  </div>

  <!-- Download Button -->
  <div class="flex justify-center sm:justify-end mt-4 sm:mt-6">
    <button id="downloadBtn" class="bg-gradient-to-r from-[#D4AF37] to-[#FFD700] text-black px-6 py-2 sm:px-8 sm:py-3 rounded-xl font-bold shadow-lg hover:scale-105 hover:shadow-[0_0_25px_#D4AF37] transition-all duration-300 w-full sm:w-auto" onclick="downloadReport()">Download Commission Report</button>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs, onSnapshot, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ---- FIREBASE CONFIG ----
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
  measurementId: "YOUR_MEASUREMENT_ID"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ----- Copy & Share -----
window.copyRef = function(){
  const refInput = document.getElementById('refLink');
  refInput.select();
  navigator.clipboard.writeText(refInput.value);
  const msg = document.getElementById('copyMsg');
  msg.classList.remove('opacity-0');
  setTimeout(()=>msg.classList.add('opacity-0'),1500);
}
window.shareLink = function(){
  const link = document.getElementById('refLink').value;
  if(navigator.share) navigator.share({title:'Join Kairah Studio',url:link});
  else alert("Copy this link to share: "+link);
}

// ----- Create Referral Code -----
async function createReferralCode(userId){
  const code = "KAI"+Math.random().toString(36).substring(2,8).toUpperCase();
  await setDoc(doc(db,"users",userId),{ referralCode: code, referredBy: null, createdAt: serverTimestamp(), totalCommissions:0, totalReferrals:0 },{ merge:true });
  return code;
}

// ----- Animate Counters -----
function animateCounter(id,value){
  let count=0;
  const increment = Math.ceil(value/50);
  const el=document.getElementById(id);
  const interval=setInterval(()=>{
    count+=increment;
    if(count>=value){count=value; clearInterval(interval);}
    el.innerText = id==='totalCommissions'||id==='totalPayouts'?"$"+count:count;
  },20);
}

// ----- Animate Bonus Bars -----
function animateBar(id,targetPercent){
  let width=0;
  const bar=document.getElementById(id);
  const interval=setInterval(()=>{
    width++;
    if(width>=targetPercent){width=targetPercent; clearInterval(interval);}
    bar.style.width=width+'%';
  },10);
}

// ----- Confetti -----
const celebratedMilestones={50:false,100:false,200:false};
function triggerBonusConfetti(current,target){
  if(current>=target && !celebratedMilestones[target]){
    celebratedMilestones[target]=true;
    confetti({ particleCount:250, spread:90, origin:{y:0.6}, colors:['#D4AF37','#FFD700','#FF4D6D'], scalar:1.2 });
  }
}

// ----- Update Dashboard -----
function updateAffiliateDashboard(data){
  document.getElementById('refLink').value="https://kairah.studio?ref="+data.referralCode;
  animateCounter('totalReferrals',data.totalReferrals||0);
  animateCounter('totalCommissions',data.totalCommissions||0);
  animateCounter('totalPayouts',data.totalPayouts||0);
  animateCounter('highTierCount',data.highTier||0);

  const bonuses=[
    {id:'p50',label:'p50Label',target:50},
    {id:'p100',label:'p100Label',target:100},
    {id:'p200',label:'p200Label',target:200}
  ];
  bonuses.forEach(b=>{
    const percent=Math.min(100,Math.round(((data.highTier||0)/b.target)*100));
    animateBar(b.id,percent);
    document.getElementById(b.label).innerText=(data.highTier||0)+' / '+b.target;
    triggerBonusConfetti(data.highTier||0,b.target);
  });
}

// ----- Leaderboard -----
async function updateLeaderboard(){
  const leaderboardEl=document.getElementById('leaderboard');
  leaderboardEl.innerHTML="<p class='text-sm opacity-50'>Loading leaderboard...</p>";

  const usersSnap=await getDocs(collection(db,"users"));
  const affiliates=[];
  usersSnap.forEach(doc=>{
    const data=doc.data();
    if(data.referralCode && data.totalCommissions) affiliates.push({name:data.name||data.referralCode,total:data.totalCommissions});
  });
  affiliates.sort((a,b)=>b.total-a.total);
  leaderboardEl.innerHTML="";
  const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
  affiliates.slice(0,10).forEach((a,i)=>{
    const p=document.createElement("p");
    p.className="text-white font-medium flex items-center gap-2";
    const medalSpan=document.createElement("span");
    medalSpan.innerText=medals[i]||'';
    if(i<3) medalSpan.className="animate-pulse";
    const nameSpan=document.createElement("span");
    nameSpan.innerHTML=`${i+1}. ${a.name} â€” $${a.total}`;
    p.appendChild(medalSpan);
    p.appendChild(nameSpan);
    leaderboardEl.appendChild(p);
  });
}

// ----- Download Commission Report -----
window.downloadReport = async function(){
  const user=auth.currentUser;
  if(!user) return alert("You must be logged in to download your report.");
  const salesSnapshot = await getDocs(query(collection(db,"sales"), where("affiliateID","==",user.uid)));
  if(salesSnapshot.empty) return alert("No sales yet to generate report.");

  let csvContent="data:text/csv;charset=utf-8,";
  csvContent+="Date,Plan,Commission ($)\n";
  salesSnapshot.forEach(doc=>{
    const data=doc.data();
    const date = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleDateString() : "N/A";
    csvContent += `${date},${data.plan},${data.commissionAmount}\n`;
  });

  const encodedUri=encodeURI(csvContent);
  const link=document.createElement("a");
  link.setAttribute("href",encodedUri);
  link.setAttribute("download", `Kairah_Studio_Commission_Report_${new Date().toLocaleDateString()}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ----- Real-time Update -----
onAuthStateChanged(auth, async(user)=>{
  if(!user) return;
  const userRef=doc(db,"users",user.uid);
  const userSnap=await getDoc(userRef);
  let code=userSnap.data()?.referralCode;
  if(!code) code=await createReferralCode(user.uid);

  // Real-time listener for commissions
  onSnapshot(userRef, snapshot=>{
    const data = snapshot.data();
    updateAffiliateDashboard({
      referralCode: data.referralCode,
      totalReferrals: data.totalReferrals,
      totalCommissions: data.totalCommissions,
      totalPayouts: 0,
      highTier: data.highTier || 0
    });
  });

  updateLeaderboard();
  setInterval(updateLeaderboard,10000);
});
</script>

</body>
</html>

